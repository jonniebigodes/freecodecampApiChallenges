'use strict';Object.defineProperty(exports,'__esModule',{value:!0}),require('babel-polyfill');var _fs=require('fs'),_mongoose=require('mongoose'),_mongoose2=_interopRequireDefault(_mongoose),_express=require('express'),_express2=_interopRequireDefault(_express),_multer=require('multer'),_multer2=_interopRequireDefault(_multer),_path=require('path'),_path2=_interopRequireDefault(_path),_bodyParser=require('body-parser'),_bodyParser2=_interopRequireDefault(_bodyParser),_logger=require('./logger'),_logger2=_interopRequireDefault(_logger);function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _asyncToGenerator(a){return function(){var b=a.apply(this,arguments);return new Promise(function(a,c){function d(e,f){try{var g=b[e](f),h=g.value}catch(a){return void c(a)}return g.done?void a(h):Promise.resolve(h).then(function(a){d('next',a)},function(a){d('throw',a)})}return d('next')})}}console.log('process.env.NODE_ENV=>'+process.env.NODE_ENV);var UserModel='production'===process.env.NODE_ENV?require('./Users.model').default:require('./src/models/Users.model').default,UrlModel='production'===process.env.NODE_ENV?require('./Urls.model').default:require('./src/models/Urls.model').default,ExerciseModel='production'===process.env.NODE_ENV?require('./Exercises.model').default:require('./src/models/Exercises.model').default,SearchModel='production'===process.env.NODE_ENV?require('./Searches.model').default:require('./src/models/Searches.model').default,SearchResultsModel='production'===process.env.NODE_ENV?require('./Searchresults.model').default:require('./src/models/Searchresults.model').default,parseMetadataHeader='production'===process.env.NODE_ENV?require('./headerParser').default:require('./src/Challenges/headerChallenge/headerParser').default,createShortUrl='production'===process.env.NODE_ENV?require('./UrlShortener').default:require('./src/Challenges/UrlshortChallenge/UrlShortener').default,getDateInfo='production'===process.env.NODE_ENV?require('./timeChecker').default:require('./src/Challenges/timeCheckChallenge/timeChecker').default,ExerciseChecks='production'===process.env.NODE_ENV?require('./Exercise').ExerciseChecks:require('./src/Challenges/ExerciseTracker/Exercise').ExerciseChecks,searchImages='production'===process.env.NODE_ENV?require('./ImgSearcher').default:require('./src/Challenges/imageSearch/ImgSearcher').default,router=_express2.default.Router(),app=(0,_express2.default)();if(app.set('port',process.env.PORT||5e3),app.use(_bodyParser2.default.json()),app.use(_bodyParser2.default.urlencoded({extended:!0})),app.use(function(a,b,c){b.header('Access-Control-Allow-Origin','*'),b.header('Access-Control-Allow-Methods','DELETE, PUT, GET, POST'),b.header('Access-Control-Allow-Headers','Origin, X-Requested-With, Content-Type, Accept'),c()}),app.use('/api',router),'production'!==process.env.NODE_ENV){require('dotenv').config();app.use(_express2.default.static(_path2.default.join(__dirname,'dist')))}'production'===process.env.NODE_ENV?app.set('MONGODB',process.env.PROD_MONGODB):app.set('MONGODB','mongodb://localhost:27017/freecodecampapichallenges'),app.set('GOOGLE_KEY',process.env.GOOGLE_KEY),app.set('GOOGLE_CX',process.env.GOOGLEAPICX),router.use(function(a,b,c){_logger2.default.info('Time=>'+new Date+'\n method=>'+a.method+'\n url=>'+a.url),c()}),router.get('/whoami',function(a,b){return b.json(parseMetadataHeader(a))}),router.post('/files',(0,_multer2.default)({dest:'./uploads/'}).single('upl'),function(a,b){var c={fileName:a.file.originalname,filetype:a.file.mimetype,FileSize:a.file.size};(0,_fs.unlink)('./uploads/'+a.file.filename,function(d){return d?b.status(500).end('error deleting file '+a.file.originalname):b.json(c)})}),router.post('/time',function(a,b){var c=getDateInfo(a.body.time);return b.json(c)}),router.route('/short').get(function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(b,c){var d,e,f;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.prev=0,a.next=3,_mongoose2.default.connect(app.get('MONGODB'),{autoIndex:!1,reconnectTries:100,reconnectInterval:2e3,poolSize:10,bufferMaxEntries:0,bufferCommands:!1});case 3:return d=_mongoose2.default.model('url'),a.next=6,d.find({});case 6:return e=a.sent,f=e.map(function(a){return{shortid:a.urlid,destination:a.urllink}}),_mongoose2.default.disconnect(),a.abrupt('return',c.json(f));case 12:return a.prev=12,a.t0=a['catch'](0),_logger2.default.error('error connecting to db:'+JSON.stringify(a.t0)),a.abrupt('return',c.status(500).json({message:'Something very bad happened in the server!!!!'}));case 16:case'end':return a.stop();}},a,void 0,[[0,12]])}));return function(){return a.apply(this,arguments)}}()).post(function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(b,c){var d,e,f,g;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.prev=0,a.next=3,_mongoose2.default.connect(app.get('MONGODB'),{autoIndex:!1,reconnectTries:100,reconnectInterval:2e3,poolSize:10,bufferMaxEntries:0,bufferCommands:!1});case 3:return d=_mongoose2.default.model('url'),a.next=6,d.find({});case 6:if(e=a.sent,f=e.find(function(a){return a.urllink===b.body.url}),!f){a.next=11;break}return _mongoose2.default.disconnect(),a.abrupt('return',c.status(500).json({message:'url already added'}));case 11:if(g=createShortUrl({url:b.body.url,urls:e}),-1!==g.shortId){a.next=15;break}return _mongoose2.default.disconnect(),a.abrupt('return',c.status(500).json({message:'Invalid URL'}));case 15:return a.next=17,d.create({urlid:g.shortId,urllink:b.body.url});case 17:return a.next=19,_mongoose2.default.disconnect();case 19:return a.abrupt('return',c.status(201).json({original_url:b.body.url,short_url:g.shortened_url}));case 22:return a.prev=22,a.t0=a['catch'](0),_logger2.default.error('error connecting to db:'+a.t0),a.abrupt('return',c.status(500).json({message:'Something very bad happened in the server!!!!'}));case 26:case'end':return a.stop();}},a,void 0,[[0,22]])}));return function(){return a.apply(this,arguments)}}()),router.get('/short/:id',function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(b,c){var d,e,f,g;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(d=/^\d+$/.test(b.params.id),d){a.next=3;break}return a.abrupt('return',c.status(500).json({message:'The value sent is not numeric, or not in conformity with the requested'}));case 3:return a.prev=3,a.next=6,_mongoose2.default.connect(app.get('MONGODB'),{autoIndex:!1,reconnectTries:100,reconnectInterval:2e3,poolSize:10,bufferMaxEntries:0,bufferCommands:!1});case 6:return e=_mongoose2.default.model('url'),f=parseInt(b.params.id,10),a.next=10,e.findOne({urlid:f});case 10:if(g=a.sent,!g){a.next=14;break}return _mongoose2.default.disconnect(),a.abrupt('return',c.redirect(g.urllink));case 14:return _mongoose2.default.disconnect(),a.abrupt('return',c.status(500).json({message:'The submitted item is not present'}));case 18:return a.prev=18,a.t0=a['catch'](3),_logger2.default.error('error connecting to db:'+a.t0),a.abrupt('return',c.status(500).json({message:'Something very bad happened in the server!!!!'}));case 22:case'end':return a.stop();}},a,void 0,[[3,18]])}));return function(){return a.apply(this,arguments)}}()),router.post('/exercise/newuser',function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(b,c){var d,e,f;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(b.body.user){a.next=2;break}return a.abrupt('return',c.status(500).json({message:'no username provided'}));case 2:return a.prev=2,a.next=5,_mongoose2.default.connect(app.get('MONGODB'),{autoIndex:!1,reconnectTries:100,reconnectInterval:2e3,poolSize:10,bufferMaxEntries:0,bufferCommands:!1});case 5:return d=_mongoose2.default.model('user'),a.next=8,d.findOne({username:b.body.user});case 8:if(e=a.sent,null===e){a.next=13;break}return a.next=12,_mongoose2.default.disconnect();case 12:return a.abrupt('return',c.status(500).json({message:'username already present'}));case 13:return a.next=15,d.create({username:b.body.user});case 15:return f=a.sent,a.next=18,_mongoose2.default.disconnect();case 18:return a.abrupt('return',c.status(201).json({message:'user created',userid:f.numseq}));case 21:return a.prev=21,a.t0=a['catch'](2),_logger2.default.error('error connecting to db:'+a.t0),a.abrupt('return',c.status(500).json({message:'Something very bad happened in the server!!!!'}));case 25:case'end':return a.stop();}},a,void 0,[[2,21]])}));return function(){return a.apply(this,arguments)}}()),router.route('/exercise').get(function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(b,c){var d,e,f;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(b.query.user){a.next=2;break}return a.abrupt('return',c.status(500).json({message:'no user provided'}));case 2:if(ExerciseChecks.checkNumeric(b.query.user)){a.next=4;break}return a.abrupt('return',c.status(500).json({message:'provided id is not valid'}));case 4:return a.prev=4,a.next=7,_mongoose2.default.connect(app.get('MONGODB'),{autoIndex:!1,reconnectTries:100,reconnectInterval:2e3,poolSize:10,bufferMaxEntries:0,bufferCommands:!1});case 7:if(d=_mongoose2.default.model('exercise'),!(b.query.limit&&ExerciseChecks.checkNumeric(b.query.limit))){a.next=15;break}return a.next=11,d.find(ExerciseChecks.ExerciseBuild({from:b.query.from,to:b.query.to,user:b.query.user})).limit(parseInt(b.query.limit,10));case 11:return e=a.sent,a.next=14,_mongoose2.default.disconnect();case 14:return a.abrupt('return',c.status(200).json(e.length?{message:'got something',items:e.map(function(a){return{description:a.exercisedescription,duration:a.exerciseduration,by:a.user}})}:{message:'Nothing found',items:[]}));case 15:return a.next=17,d.find(ExerciseChecks.ExerciseBuild({from:b.query.from,to:b.query.to,user:b.query.user}));case 17:return f=a.sent,a.next=20,_mongoose2.default.disconnect();case 20:return a.abrupt('return',c.status(200).json(f.length?{message:'got something',items:f.map(function(a){return{description:a.exercisedescription,duration:a.exerciseduration,by:a.user}})}:{message:'Nothing found',items:[]}));case 23:return a.prev=23,a.t0=a['catch'](4),_logger2.default.error('error connecting to db:'+a.t0),a.abrupt('return',c.status(500).json({message:'Something very bad happened in the server!!!!'}));case 27:case'end':return a.stop();}},a,void 0,[[4,23]])}));return function(){return a.apply(this,arguments)}}()).post(function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(b,c){var d,e;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(b.body.userdata){a.next=2;break}return a.abrupt('return',c.status(500).json({message:'no username provided'}));case 2:if(b.body.desc){a.next=4;break}return a.abrupt('return',c.status(500).json({message:'no exercice description provided'}));case 4:if(b.body.duration){a.next=6;break}return a.abrupt('return',c.status(500).json({message:'no exercice duration provided'}));case 6:if(ExerciseChecks.checkNumeric(b.body.duration)){a.next=8;break}return a.abrupt('return',c.status(500).json({message:'exercise duration invalid'}));case 8:return a.prev=8,a.next=11,_mongoose2.default.connect(app.get('MONGODB'),{autoIndex:!1,reconnectTries:100,reconnectInterval:2e3,poolSize:10,bufferMaxEntries:0,bufferCommands:!1});case 11:return d=_mongoose2.default.model('exercise'),a.next=14,d.findOne({exercisedescription:b.body.desc,exerciseduration:parseInt(b.body.duration,10)});case 14:if(e=a.sent,!e){a.next=18;break}return _mongoose2.default.disconnect(),a.abrupt('return',c.status(500).json({message:'a similar exercise was already provided'}));case 18:if(!(b.body.exercisedate&&ExerciseChecks.isValidDate(b.body.exercisedate))){a.next=23;break}return a.next=21,d.create({user:b.body.userdata,exercisedescription:b.body.desc,exerciseduration:parseInt(b.body.duration,10),created:ExerciseChecks.formatDate(b.body.exercisedate)});case 21:a.next=25;break;case 23:return a.next=25,d.create({user:b.body.userdata,exercisedescription:b.body.desc,exerciseduration:parseInt(b.body.duration,10)});case 25:return a.next=27,_mongoose2.default.disconnect();case 27:return a.abrupt('return',c.status(201).json({message:'Exercise was created with success'}));case 30:return a.prev=30,a.t0=a['catch'](8),_logger2.default.error('error connecting to db:'+a.t0),a.abrupt('return',c.status(500).json({message:'Something very bad happened in the server!!!!'}));case 34:case'end':return a.stop();}},a,void 0,[[8,30]])}));return function(){return a.apply(this,arguments)}}()),router.get('/imagesearch',function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(b,c){var d,e,f,g,h,i,j,k;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(b.query.searchquery){a.next=2;break}return a.abrupt('return',c.status(500).json({message:'cannot search nothing'}));case 2:return a.prev=2,a.next=5,_mongoose2.default.connect(app.get('MONGODB'),{autoIndex:!1,reconnectTries:100,reconnectInterval:2e3,poolSize:10,bufferMaxEntries:0,bufferCommands:!1});case 5:return d=_mongoose2.default.model('search'),e=_mongoose2.default.model('searchresult'),a.next=9,d.findOne({searchwords:b.query.searchquery});case 9:if(f=a.sent,!f){a.next=17;break}return a.next=13,e.find({idsearch:f.searchid});case 13:return g=a.sent,a.next=16,_mongoose2.default.disconnect();case 16:return a.abrupt('return',c.status(200).json({query:f.searchwords,numresults:f.numresults,queryresults:g.length?g.map(function(a){return{name:a.titleimage,link:a.urllink,width:a.width,height:a.height,thumbHeight:a.thumbnailHeight,thumbWidth:a.thumbnailWidth,sizefile:a.filesize}}):[]}));case 17:return h=/^\d+$/.test(b.query.numitems),a.next=20,searchImages({key:app.get('GOOGLE_KEY'),cx:app.get('GOOGLE_CX'),items:h?parseInt(b.query.numitems,10):10,query:b.query.searchquery});case 20:return i=a.sent,a.next=23,d.create({searchwords:b.query.searchquery,numresults:h?parseInt(b.query.numitems,10):10});case 23:return j=a.sent,k=i.searchresults.map(function(a){return Object.assign({},a,{idsearch:j.searchid})}),a.next=27,e.create(k);case 27:return a.next=29,_mongoose2.default.disconnect();case 29:return a.abrupt('return',c.status(200).json({query:b.query.searchquery,numresults:h?parseInt(b.query.numitems,10):10,queryresults:i.searchresults}));case 32:return a.prev=32,a.t0=a['catch'](2),_logger2.default.error('error connecting to db:'+a.t0),a.abrupt('return',c.status(500).json({message:'Something very bad happened in the server!!!!'}));case 36:case'end':return a.stop();}},a,void 0,[[2,32]])}));return function(){return a.apply(this,arguments)}}()),router.get('/imagesearch/latest',function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(b,c){var d,e;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.prev=0,a.next=3,_mongoose2.default.connect(app.get('MONGODB'),{autoIndex:!1,reconnectTries:100,reconnectInterval:2e3,poolSize:10,bufferMaxEntries:0,bufferCommands:!1});case 3:return d=_mongoose2.default.model('search'),a.next=6,d.find({});case 6:return e=a.sent,a.next=9,_mongoose2.default.disconnect();case 9:return a.abrupt('return',c.status(200).json({latestsearches:e.map(function(a){return{searchquery:a.searchwords,results:a.numresults}})}));case 12:return a.prev=12,a.t0=a['catch'](0),_logger2.default.error('error connecting to db:'+a.t0),a.abrupt('return',c.status(500).json({message:'Something very bad happened in the server!!!!'}));case 16:case'end':return a.stop();}},a,void 0,[[0,12]])}));return function(){return a.apply(this,arguments)}}()),app.get('*',function(a,b){'production'!==process.env.NODE_ENV&&b.sendFile('index.html',{root:_path2.default.join(__dirname,'./dist/')}),b.sendFile('index.html',{root:_path2.default.join(__dirname,'../dist/')})}),app.listen(app.get('port'),function(a){a?_logger2.default.error('error freecodecampdyn:'+a):_logger2.default.info('freecodecamp app is running on port '+app.get('port'))}),exports.default=app;
